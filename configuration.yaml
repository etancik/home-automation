# Home Assistant Configuration - House Location
# GitOps managed via Git Pull add-on

# Basic Home Assistant configuration
homeassistant:
  # Name of the location
  name: "House"
  # Location coordinates (Prague defaults - update secrets.yaml with real values)
  latitude: !secret house_latitude
  longitude: !secret house_longitude
  elevation: !secret house_elevation
  # Unit system and locale
  unit_system: metric
  country: CZ
  language: en-GB  # British English: Monday as first day, European date formats
  time_zone: Europe/Prague
  currency: CZK
  # Load packages from both core and location-specific directories
  packages:
    core: !include_dir_merge_named ../../core/packages
    local: !include_dir_merge_named packages

# Enable sun integration for sunrise/sunset data
sun:
  # Location customizations
  customize: !include customize.yaml

# Loads default set of integrations
# Note: default_config does not support exclude parameters in current HA version
# USB discovery is now controlled via integration settings instead
default_config:

# Load frontend themes from the themes folder  
frontend:
  themes: !include_dir_merge_named themes

# Lovelace dashboards
lovelace:
  mode: storage  # Main dashboard via UI
  # Additional YAML dashboards
  dashboards:
    ev-power-monitor:
      mode: yaml
      title: EV Power Monitor
      icon: mdi:car-electric
      show_in_sidebar: true
      filename: dashboards/ev_power_monitoring.yaml

# Note: MQTT integration is configured via UI (Settings > Devices & Services)
# The Zigbee2MQTT add-on will automatically configure MQTT discovery

# Core configuration files
automation: !include automations.yaml
script: !include scripts.yaml  
scene: !include scenes.yaml

# Floor Heating Control Configuration
# Template sensors and covers
template:
  - binary_sensor:
      # Washing Machine Status (HomeKit Contact Sensor)
      # Closed (OFF) = Running (power >10W, busy)
      # Open (ON) = Done/Idle (power ≤10W, available)
      # Setup in HomeKit: Automation → When "Washing Machine" opens → Send notification
      - name: "Washing Machine"
        unique_id: washing_machine_done
        device_class: opening
        state: >
          {{ states('sensor.laundry_room_washing_machine_smart_plug_power') | float(0) <= 10 }}
        availability: >
          {{ states('sensor.laundry_room_washing_machine_smart_plug_power') not in ['unknown', 'unavailable'] }}
  
  - sensor:
      # Extract current temperature from downstairs bathroom radiator valve for floor heating control
      - name: "Downstairs Bathroom Temperature"
        unique_id: downstairs_bathroom_temperature
        unit_of_measurement: "°C"
        device_class: temperature
        state: >
          {{ state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20) }}
      
      # Grid Energy Consumption (fixed state_class for Energy dashboard)
      - name: "Grid Energy Consumed"
        unique_id: grid_energy_consumed
        state: "{{ states('sensor.go_econtroller_917809_grid_energy_in') | float(0) }}"
        unit_of_measurement: "Wh"
        device_class: energy
        state_class: total_increasing
        availability: "{{ has_value('sensor.go_econtroller_917809_grid_energy_in') }}"
        attributes:
          friendly_name: "Grid Energy Consumed"
          source: "go-eController Grid Energy In (state_class fixed)"
      
      # Home Energy Consumption (fixed state_class for Energy dashboard)
      - name: "Home Energy Consumed"
        unique_id: home_energy_consumed
        state: "{{ states('sensor.go_econtroller_917809_home_energy_in') | float(0) }}"
        unit_of_measurement: "Wh"
        device_class: energy
        state_class: total_increasing
        availability: "{{ has_value('sensor.go_econtroller_917809_home_energy_in') }}"
        attributes:
          friendly_name: "Home Energy Consumed"
          source: "go-eController Home Energy In (state_class fixed)"
  
  # Garage Door Cover (modern template syntax)
  # Uses Hörmann Promatic 3 status feedback via Shelly Plus1PM
  - cover:
      - name: "Garage Door"
        unique_id: garage_door
        device_class: garage
        state: >
          {% if is_state('binary_sensor.door_lock', 'off') %}
            closed
          {% elif is_state('binary_sensor.door_lock', 'on') %}
            open
          {% else %}
            unknown
          {% endif %}
        open_cover:
          - service: switch.turn_on
            target:
              entity_id: switch.garage_door
        close_cover:
          - service: switch.turn_on
            target:
              entity_id: switch.garage_door
        stop_cover:
          - service: switch.turn_on
            target:
              entity_id: switch.garage_door

# Energy Tracking for Washing Machine
# Uses Riemann sum integration to convert power (W) to energy (kWh)
sensor:
  # Washing Machine Energy Tracking
  - platform: integration
    source: sensor.laundry_room_washing_machine_smart_plug_power
    name: "Washing Machine Energy"
    unique_id: washing_machine_energy
    unit_prefix: k
    round: 2
    method: left

# Two zones controlled by Aqara Dual Relay T2 (0x54ef44100148cb6d) with Elektrobock SEH101-NC actuators
climate:
  # Zone 1: Kitchen + Living Room floor heating (Relay L1)
  - platform: generic_thermostat
    name: "Living Room Floor Heating"
    unique_id: living_room_floor_heating
    heater: switch.floor_heating_controller_l1
    target_sensor: sensor.living_room_temperature_sensor_temperature
    min_temp: 4
    max_temp: 35
    cold_tolerance: 1.0
    hot_tolerance: 0
    initial_hvac_mode: "heat"
  
  # Zone 2: Downstairs Bathroom floor heating (Relay L2)
  # Uses template sensor extracting temperature from radiator valve
  - platform: generic_thermostat
    name: "Downstairs Bathroom Floor Heating"
    unique_id: downstairs_bathroom_floor_heating
    heater: switch.floor_heating_controller_l2
    target_sensor: sensor.downstairs_bathroom_temperature
    min_temp: 4
    max_temp: 35
    cold_tolerance: 1.0
    hot_tolerance: 0
    initial_hvac_mode: "heat"

# HomeKit Integration - Single Consolidated Bridge
homekit:
  - name: "House Main"
    port: 21064
    safe_mode: true
    filter:
      include_entities:
        # ========================================
        # ENVIRONMENTAL SENSORS (CO2 + Other)
        # ========================================
        
        # CO2 Sensors (alphabetical by room)
        - sensor.bedroom_co2_sensor_co2
        - sensor.living_room_co2_sensor_co2
        
        # Food Storage Sensor (kitchen)
        - sensor.food_storage_sensor_temperature
        - sensor.food_storage_sensor_humidity
        - sensor.food_storage_sensor_pressure
        - sensor.food_storage_sensor_battery
        
        # External Temperature Sensors (alphabetical by room)
        - sensor.bedroom_temperature_sensor_temperature
        - sensor.bedroom_temperature_sensor_humidity
        - sensor.bedroom_temperature_sensor_battery
        - sensor.entrance_temperature_sensor_temperature
        - sensor.entrance_temperature_sensor_humidity
        - sensor.entrance_temperature_sensor_battery
        - sensor.kids_room_temperature_sensor_temperature
        - sensor.kids_room_temperature_sensor_humidity
        - sensor.kids_room_temperature_sensor_battery
        - sensor.living_room_temperature_sensor_temperature
        - sensor.living_room_temperature_sensor_humidity
        - sensor.living_room_temperature_sensor_battery
        - sensor.workshop_temperature_sensor_temperature
        - sensor.workshop_temperature_sensor_humidity
        - sensor.workshop_temperature_sensor_battery
        
        # ========================================
        # CONTACT SENSORS (Windows/Doors)
        # ========================================
        
        # Window/Door Sensors (alphabetical by room)
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.entrance_door_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
        - binary_sensor.kitchen_window_sensor_contact
        - binary_sensor.living_room_door_sensor_contact
        - binary_sensor.workshop_window_sensor_contact
        
        # ========================================
        # LEAK SENSORS
        # ========================================
        
        # Leak Sensors (alphabetical by room)
        - binary_sensor.downstairs_bathroom_leak_sensor_water_leak
        - binary_sensor.kitchen_sink_leak_sensor_water_leak
        - binary_sensor.laundry_room_leak_sensor_water_leak
        - binary_sensor.upstairs_bathroom_leak_sensor_water_leak
        
        # ========================================
        # SMOKE DETECTORS
        # ========================================
        
        # Smoke Detectors (Shelly Smoke Plus)
        - binary_sensor.living_room_smoke_detector_smoke
        - sensor.living_room_smoke_detector_battery
        
        # ========================================
        # HEAT CONTROL (Climate Controls)
        # ========================================
        
        # Heat Valves (alphabetical by room)
        - climate.bedroom_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.upstairs_bathroom_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        
        # Floor Heating Zones (thermostats only, relays hidden)
        - climate.living_room_floor_heating
        - climate.downstairs_bathroom_floor_heating
        
        # ========================================
        # LIGHTING
        # ========================================
        
        # Lights (alphabetical by room)
        - light.bedroom_led_strip
        - light.kids_room_door_led_strip
        - light.living_room_light
        
        # ========================================
        # SMART PLUGS & APPLIANCES
        # ========================================
        
        # Washing Machine (notifies when done)
        - binary_sensor.washing_machine
        
        # ========================================
        # BOILER CONTROL
        # ========================================
        
        # Dual Relay Boiler Controller (L2+LOUT wired as single dry contact)
        # Only expose L2 to HomeKit - L2 relay controls the boiler
        - switch.laundry_room_boiler_controller_l2
        
        # ========================================
        # GARAGE DOOR
        # ========================================
        
        # Garage Door (control + position feedback)
        - cover.garage_door
        - binary_sensor.door_lock
    entity_config:
      # ========================================
      # ENVIRONMENTAL SENSORS
      # ========================================
      
      # CO2 Sensors
      sensor.bedroom_co2_sensor_co2:
        name: "Bedroom CO2"
        # CO2 threshold: HomeKit will warn when > 1500 ppm (default is 1000)
        co2_threshold: 1500
      sensor.bedroom_co2_sensor_temperature:
        name: "Bedroom Temperature (CO2)"
      sensor.bedroom_co2_sensor_humidity:
        name: "Bedroom Humidity (CO2)"
      sensor.living_room_co2_sensor_co2:
        name: "Living Room CO2"
        # CO2 threshold: HomeKit will warn when > 1500 ppm (default is 1000)
        co2_threshold: 1500
      sensor.living_room_co2_sensor_temperature:
        name: "Living Room Temperature (CO2)"
      sensor.living_room_co2_sensor_humidity:
        name: "Living Room Humidity (CO2)"
      
      # Food Storage Sensor
      sensor.food_storage_sensor_temperature:
        name: "Kitchen Food Storage Temperature"
      sensor.food_storage_sensor_humidity:
        name: "Kitchen Food Storage Humidity"
      sensor.food_storage_sensor_pressure:
        name: "Kitchen Food Storage Pressure"
      sensor.food_storage_sensor_battery:
        name: "Kitchen Sensor Battery"
      
      # External Temperature Sensors (alphabetical by room)
      sensor.bedroom_temperature_sensor_temperature:
        name: "Bedroom Temperature"
      sensor.entrance_temperature_sensor_temperature:
        name: "Entrance Temperature"
      sensor.kids_room_temperature_sensor_temperature:
        name: "Kids Room Temperature"
      sensor.living_room_temperature_sensor_temperature:
        name: "Living Room Temperature"
      sensor.workshop_temperature_sensor_temperature:
        name: "Workshop Temperature"
      
      # ========================================
      # CONTACT SENSORS
      # ========================================
      
      # Window/Door Sensors (alphabetical by room)
      binary_sensor.bedroom_window_sensor_contact:
        name: "Bedroom Window"
      binary_sensor.kids_room_window_sensor_contact:
        name: "Kids Room Window"
      binary_sensor.kitchen_window_sensor_contact:
        name: "Kitchen Window"
      binary_sensor.living_room_door_sensor_contact:
        name: "Living Room Door"
      binary_sensor.workshop_window_sensor_contact:
        name: "Workshop Window"
      
      # ========================================
      # LEAK SENSORS
      # ========================================
      
      # Leak Sensors (alphabetical by room)
      binary_sensor.downstairs_bathroom_leak_sensor_water_leak:
        name: "Downstairs Bathroom Leak"
      binary_sensor.kitchen_sink_leak_sensor_water_leak:
        name: "Kitchen Sink Leak"
      binary_sensor.laundry_room_leak_sensor_water_leak:
        name: "Laundry Room Leak"
      binary_sensor.upstairs_bathroom_leak_sensor_water_leak:
        name: "Upstairs Bathroom Leak"
      
      # ========================================
      # SMOKE DETECTORS
      # ========================================
      
      # Smoke Detectors (Shelly Smoke Plus)
      binary_sensor.living_room_smoke_detector_smoke:
        name: "Living Room Smoke"
      sensor.living_room_smoke_detector_battery:
        name: "Living Room Smoke Detector Battery"
      
      # ========================================
      # HEAT CONTROL
      # ========================================
      
      # Heat Valves (alphabetical by room)
      climate.bedroom_radiator_heat_valve:
        name: "Bedroom Heating"
      
      # ========================================
      # APPLIANCES
      # ========================================
      
      # Washing Machine Sensor
      binary_sensor.washing_machine:
        name: "Washing Machine"
      
      # ========================================
      # BOILER CONTROL
      # ========================================
      
      # Boiler Controller
      climate.downstairs_bathroom_radiator_heat_valve:
        name: "Downstairs Bathroom Radiator"
      climate.entrance_radiator_heat_valve:
        name: "Entrance Heating"
      climate.kids_room_radiator_heat_valve:
        name: "Kids Room Heating"
      climate.upstairs_bathroom_radiator_heat_valve:
        name: "Upstairs Bathroom Heating"
      climate.workshop_radiator_heat_valve:
        name: "Workshop Heating"
      
      # Floor Heating Zones
      climate.living_room_floor_heating:
        name: "Living Room Floor"
      climate.downstairs_bathroom_floor_heating:
        name: "Downstairs Bathroom Floor"
      
      # ========================================
      # LIGHTING
      # ========================================
      
      # Lights (alphabetical by room)
      light.bedroom_led_strip:
        name: "Bedroom LED Strip"
      light.kids_room_door_led_strip:
        name: "Kids Room Door LED Strip"
      light.living_room_light:
        name: "Living Room Light"
      
      # ========================================
      # BOILER CONTROL
      # ========================================
      
      # Dual Relay Boiler Controller (L2+LOUT wired as single dry contact)
      # Only L2 exposed to HomeKit - L2 relay controls the boiler
      switch.laundry_room_boiler_controller_l2:
        name: "Boiler Control"
      
      # ========================================
      # GARAGE DOOR
      # ========================================
      
      # Garage Door (control + position feedback)
      cover.garage_door:
        name: "Garage Door"
      binary_sensor.door_lock:
        name: "Garage Door Position"

# Shell commands for GitOps deployment
shell_command:
  deploy_zigbee2mqtt_config: >
    cp /config/zigbee2mqtt_configuration.yaml /config/zigbee2mqtt/configuration.yaml

# Recorder configuration for database optimization
recorder:
  db_url: "sqlite:////config/home-assistant_v2.db"
  purge_keep_days: 30
  include:
    domains:
      - sensor
      - light
      - switch
      - binary_sensor
      - automation
      - person
      - device_tracker
      - input_number
      - input_boolean
  exclude:
    entity_globs:
      - sensor.*_linkquality
      - sensor.*_voltage
      - sensor.*_update_state
      - sensor.home_assistant_*
      - sensor.*_cpu_percent
      - sensor.*_memory_percent

# Logger configuration
logger:
  default: info
  logs:
    homeassistant.components.mqtt: info
    homeassistant.components.automation: info