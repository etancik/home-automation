# House-specific automations
# Migrated and cleaned up from current HA setup

# GitOps Deployment Automation
- id: 'zigbee2mqtt_gitops_deploy'
  alias: "Deploy Zigbee2MQTT Configuration from Git"
  description: "Automatically deploy Git-managed Z2M config when changed"
  triggers:
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    - service: shell_command.deploy_zigbee2mqtt_config
      data: {}
    - delay: 5
    - service: hassio.addon_restart
      data:
        addon: 45df7312_zigbee2mqtt
  mode: single

# House Automations
# Location-specific automations for the house

# CO2 Air Quality LED Notifications
- id: 'co2_led_notification'
  alias: "CO2 Air Quality LED Notifications"
  description: "Adjust LED strip colors based on CO2 levels and window states for air quality awareness"
  triggers:
    # Monitor bedroom CO2 levels
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      above: 1500
      id: bedroom_high_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 1500
      above: 800
      id: bedroom_normal_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 800
      id: bedroom_low_co2
    # Monitor window state changes (bedroom and kids room only)
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
      id: window_state_change
  conditions: []
  actions:
    - choose:
        # High CO2 + Windows closed -> Pulse (alert to open windows)
        - conditions:
            - condition: trigger
              id: bedroom_high_co2
            - condition: state
              entity_id: binary_sensor.bedroom_window_sensor_contact
              state: 'off'  # Bedroom window closed
            - condition: state
              entity_id: binary_sensor.kids_room_window_sensor_contact
              state: 'off'  # Kids room window closed
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Low CO2 + Windows open in winter -> Pulse (alert to close windows)
        - conditions:
            - condition: trigger
              id: bedroom_low_co2
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.bedroom_window_sensor_contact
                  state: 'on'  # Bedroom window open
                - condition: state
                  entity_id: binary_sensor.kids_room_window_sensor_contact
                  state: 'on'  # Kids room window open
            # Winter condition: October through March
            - condition: template
              value_template: >
                {% set month = now().month %}
                {{ month >= 10 or month <= 3 }}
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Normal/Low CO2 + Windows closed -> Stop pulsing, return to normal
        - conditions:
            - condition: or
              conditions:
                # Normal CO2 reached
                - condition: trigger
                  id: bedroom_normal_co2
                # Window closed while low CO2
                - condition: and
                  conditions:
                    - condition: trigger
                      id: window_state_change
                    - condition: template
                      value_template: "{{ trigger.to_state.state == 'off' }}"  # Window closed
                    - condition: numeric_state
                      entity_id: sensor.bedroom_co2_sensor_co2
                      below: 800
          sequence:
            # Note: LED breathing effects now automatically restore original state
            # No manual restoration needed for low CO2 notification
        
        # High CO2 + Window opened -> Stop pulsing, return to normal
        - conditions:
            - condition: trigger
              id: window_state_change
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window opened
            - condition: numeric_state
              entity_id: sensor.bedroom_co2_sensor_co2
              above: 1500
          sequence:
            # Note: LED breathing effects now automatically restore original state  
            # No manual restoration needed when windows open
  mode: queued
  max: 10

# Heat Valve External Temperature Sync
- id: 'heat_valves_external_temperature_sync'
  alias: "Heat Valves External Temperature Sync"
  description: "Configure heat valves to use external sensors for heating control"
  triggers:
    - platform: state
      entity_id: 
        - sensor.bedroom_temperature_sensor_temperature
        - sensor.kids_room_temperature_sensor_temperature
        - sensor.workshop_temperature_sensor_temperature
        - sensor.entrance_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    # Only run if all temperature sensors are available
    - condition: template
      value_template: >
        {{ states('sensor.bedroom_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.kids_room_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.workshop_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.entrance_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}
  actions:
    # Wait for Zigbee2MQTT to initialize after startup
    - delay:
        seconds: 30
    # Configure each valve: external sensor + minimal 0.2°C hysteresis for centralized boiler control
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    # Configure bathroom valves with minimal hysteresis
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Downstairs Bathroom Radiator Heat Valve/set"
        payload: '{"temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Upstairs Bathroom Radiator Heat Valve/set"
        payload: '{"temperature_accuracy": -0.2}'
    # Sync current temperature readings
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.bedroom_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.kids_room_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.workshop_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.entrance_temperature_sensor_temperature') | float(20) }}}
  mode: queued
  max: 5

# Window State Synchronization for All Heat Valves
- id: 'heat_valves_window_sync_all'
  alias: "Heat Valves Window State Sync (All Rooms)"
  description: "Turn off heating when windows open, resume when windows close for all heat valves with window sensors"
  triggers:
    # Monitor all window sensors that have corresponding heat valves
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.entrance_door_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
        - binary_sensor.workshop_window_sensor_contact
  conditions: []
  actions:
    # Only process the room that triggered this automation
    - variables:
        room_map:
          binary_sensor.bedroom_window_sensor_contact:
            name: "Bedroom"
            valve: "Bedroom Radiator Heat Valve"
          binary_sensor.entrance_door_sensor_contact:
            name: "Entrance"
            valve: "Entrance Radiator Heat Valve"
          binary_sensor.kids_room_window_sensor_contact:
            name: "Kids Room"
            valve: "Kids Room Radiator Heat Valve"
          binary_sensor.workshop_window_sensor_contact:
            name: "Workshop"
            valve: "Workshop Radiator Heat Valve"
    - variables:
        room_config: "{{ room_map[trigger.entity_id] }}"
    # Check if sensor is available
    - if:
        - condition: template
          value_template: "{{ trigger.to_state.state in ['unknown', 'unavailable'] }}"
      then:
        - service: logbook.log
          data:
            name: "Heat Valve Window Sync"
            message: "{{ room_config.name }} sensor offline - skipping heating control"
      else:
        # Sensor available - control heating based on state
        - if:
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window/Door OPEN
          then:
            - service: mqtt.publish
              data:
                topic: "zigbee2mqtt/{{ room_config.valve }}/set"
                payload: '{"system_mode": "off"}'
            - service: logbook.log
              data:
                name: "Heat Valve Window Sync"
                message: "{{ room_config.name }} window/door opened - heating turned OFF"
          else:
            - service: mqtt.publish
              data:
                topic: "zigbee2mqtt/{{ room_config.valve }}/set"
                payload: '{"system_mode": "heat"}'
            - service: logbook.log
              data:
                name: "Heat Valve Window Sync"
                message: "{{ room_config.name }} window/door closed - heating resumed"
  mode: queued
  max: 5

# Floor Heating Window/Door State Synchronization
- id: 'floor_heating_window_sync'
  alias: "Floor Heating Window/Door Sync"
  description: "Turn off floor heating when windows/doors open, resume when closed"
  triggers:
    # Monitor kitchen window and living room door for Living Room floor heating zone
    - platform: state
      entity_id: 
        - binary_sensor.kitchen_window_sensor_contact
        - binary_sensor.living_room_door_sensor_contact
  conditions: []
  actions:
    # Living Room floor heating zone affected by both kitchen window and living room door
    - variables:
        # Check if EITHER kitchen window OR living room door is open
        any_opening_open: >
          {{ is_state('binary_sensor.kitchen_window_sensor_contact', 'on') or 
             is_state('binary_sensor.living_room_door_sensor_contact', 'on') }}
    - if:
        - condition: template
          value_template: "{{ any_opening_open }}"
      then:
        # Turn OFF Living Room floor heating when any opening is open
        - service: climate.turn_off
          target:
            entity_id: climate.living_room_floor_heating
        - service: logbook.log
          data:
            name: "Floor Heating Window Sync"
            message: >
              Living Room floor heating turned OFF - 
              Kitchen window: {{ states('binary_sensor.kitchen_window_sensor_contact') }}, 
              Living room door: {{ states('binary_sensor.living_room_door_sensor_contact') }}
      else:
        # Turn ON Living Room floor heating when both openings are closed
        - service: climate.turn_on
          target:
            entity_id: climate.living_room_floor_heating
        - service: logbook.log
          data:
            name: "Floor Heating Window Sync"
            message: "Living Room floor heating resumed - all openings closed"
  mode: single

# Boiler Control Automation
- id: 'boiler_heating_control'
  alias: "Boiler Heating Control"
  description: "Control boiler based on radiator valve and floor heating zone demands"
  triggers:
    # Monitor all radiator valve states for heating demand
    - platform: state
      entity_id: 
        - climate.bedroom_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.upstairs_bathroom_radiator_heat_valve
    # Monitor floor heating zone states
    - platform: state
      entity_id:
        - climate.living_room_floor_heating
        - climate.downstairs_bathroom_floor_heating
    # Monitor living room temperature changes (for floor heating zone)
    - platform: state
      entity_id: sensor.living_room_temperature_sensor_temperature
    # Monitor boiler state changes
    - platform: state
      entity_id: switch.laundry_room_boiler_controller_l2
    # Periodic check every 2 minutes to re-evaluate heating needs
    - platform: time_pattern
      minutes: "/2"
    # Startup trigger
    - platform: homeassistant
      event: start
  conditions:
    # Only run if boiler controller is available
    - condition: template
      value_template: >
        {{ states('switch.laundry_room_boiler_controller_l2') not in ['unknown', 'unavailable'] }}
  actions:
    # DIAGNOSTIC: Log current state of all rooms
    - service: logbook.log
      data:
        name: "Boiler Control Debug"
        message: >
          Room States:
          LR Floor: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C / {{ state_attr('climate.living_room_floor_heating', 'temperature') }}°C ({{ state_attr('climate.living_room_floor_heating', 'hvac_action') }})
          | Bedroom: {{ states('sensor.bedroom_temperature_sensor_temperature') }}°C / {{ state_attr('climate.bedroom_radiator_heat_valve', 'temperature') }}°C ({{ state_attr('climate.bedroom_radiator_heat_valve', 'hvac_mode') }})
          | Kids: {{ states('sensor.kids_room_temperature_sensor_temperature') }}°C / {{ state_attr('climate.kids_room_radiator_heat_valve', 'temperature') }}°C ({{ state_attr('climate.kids_room_radiator_heat_valve', 'hvac_mode') }})
          | Workshop: {{ states('sensor.workshop_temperature_sensor_temperature') }}°C / {{ state_attr('climate.workshop_radiator_heat_valve', 'temperature') }}°C ({{ state_attr('climate.workshop_radiator_heat_valve', 'hvac_mode') }})
          | Entrance: {{ states('sensor.entrance_temperature_sensor_temperature') }}°C / {{ state_attr('climate.entrance_radiator_heat_valve', 'temperature') }}°C ({{ state_attr('climate.entrance_radiator_heat_valve', 'hvac_mode') }})
          | Bath Down Rad: {{ state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') }}°C / {{ state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'temperature') }}°C
          | Bath Down Floor: {{ state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') }}°C / {{ state_attr('climate.downstairs_bathroom_floor_heating', 'temperature') }}°C ({{ state_attr('climate.downstairs_bathroom_floor_heating', 'hvac_action') }})
          | Bath Up: {{ state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'current_temperature') }}°C / {{ state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'temperature') }}°C
          | Boiler: {{ states('switch.laundry_room_boiler_controller_l2') }}
    
    # EVALUATE TURN OFF FIRST: Check if all rooms satisfied
    - if:
        - condition: and
          conditions:
            # Radiator zones with windows: satisfied OR disabled by window
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.bedroom_radiator_heat_valve', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.bedroom_temperature_sensor_temperature') | float(20)) >= 
                       (state_attr('climate.bedroom_radiator_heat_valve', 'temperature') | float(20)) }}
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.kids_room_radiator_heat_valve', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.kids_room_temperature_sensor_temperature') | float(20)) >= 
                       (state_attr('climate.kids_room_radiator_heat_valve', 'temperature') | float(20)) }}
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.workshop_radiator_heat_valve', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.workshop_temperature_sensor_temperature') | float(20)) >= 
                       (state_attr('climate.workshop_radiator_heat_valve', 'temperature') | float(20)) }}
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.entrance_radiator_heat_valve', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.entrance_temperature_sensor_temperature') | float(20)) >= 
                       (state_attr('climate.entrance_radiator_heat_valve', 'temperature') | float(20)) }}
            # Bathroom radiators: satisfied (no windows, always active)
            - condition: template
              value_template: >
                {{ (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) >= 
                   (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'temperature') | float(20)) }}
            - condition: template
              value_template: >
                {{ (state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) >= 
                   (state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'temperature') | float(20)) }}
            # Floor heating zones: satisfied OR disabled
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.living_room_floor_heating', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.living_room_temperature_sensor_temperature') | float(25)) >= 
                       (state_attr('climate.living_room_floor_heating', 'temperature') | float(21)) }}
            - condition: or
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.downstairs_bathroom_floor_heating', 'hvac_mode') == 'off' }}
                - condition: template
                  value_template: >
                    {{ (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) >= 
                       (state_attr('climate.downstairs_bathroom_floor_heating', 'temperature') | float(22)) }}
      then:
        # Turn off boiler - heating complete
        - service: switch.turn_off
          target:
            entity_id: switch.laundry_room_boiler_controller_l2
        - service: logbook.log
          data:
            name: "Boiler Control"
            message: "Boiler turned OFF - Heating complete: All zones satisfied (radiators + floor heating)"
        - stop: ""
    
    # EVALUATE TURN ON: Check if ANY room needs heating
    - if:
        - condition: or
          conditions:
            # Check if any radiator room with external sensor is 1°C below setpoint AND valve is enabled (not disabled by window)
            - condition: and
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.bedroom_radiator_heat_valve', 'hvac_mode') != 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.bedroom_temperature_sensor_temperature') | float(20)) < 
                       (state_attr('climate.bedroom_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            - condition: and
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.kids_room_radiator_heat_valve', 'hvac_mode') != 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.kids_room_temperature_sensor_temperature') | float(20)) < 
                       (state_attr('climate.kids_room_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            - condition: and
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.workshop_radiator_heat_valve', 'hvac_mode') != 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.workshop_temperature_sensor_temperature') | float(20)) < 
                       (state_attr('climate.workshop_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            - condition: and
              conditions:
                - condition: template
                  value_template: >
                    {{ state_attr('climate.entrance_radiator_heat_valve', 'hvac_mode') != 'off' }}
                - condition: template
                  value_template: >
                    {{ (states('sensor.entrance_temperature_sensor_temperature') | float(20)) < 
                       (state_attr('climate.entrance_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            # Check bathrooms with internal sensors (no window sensors, always active)
            - condition: template
              value_template: >
                {{ (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) < 
                   (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            - condition: template
              value_template: >
                {{ (state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) < 
                   (state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'temperature') | float(20) - 1.0) }}
            # Check floor heating zones (only if enabled AND 1°C below target)
            - condition: and
              conditions:
                # Living Room floor heating enabled
                - condition: template
                  value_template: >
                    {{ state_attr('climate.living_room_floor_heating', 'hvac_mode') == 'heat' }}
                # Temperature below target - 1°C (heat threshold with hysteresis)
                - condition: template
                  value_template: >
                    {{ (states('sensor.living_room_temperature_sensor_temperature') | float(25)) < 
                       (state_attr('climate.living_room_floor_heating', 'temperature') | float(21) - 1.0) }}
            - condition: and
              conditions:
                # Downstairs Bathroom floor heating enabled
                - condition: template
                  value_template: >
                    {{ state_attr('climate.downstairs_bathroom_floor_heating', 'hvac_mode') == 'heat' }}
                # Temperature below target - 1°C (heat threshold with hysteresis)
                - condition: template
                  value_template: >
                    {{ (state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'current_temperature') | float(20)) < 
                       (state_attr('climate.downstairs_bathroom_floor_heating', 'temperature') | float(22) - 1.0) }}
      then:
            # Turn on boiler - heating needed
            - service: switch.turn_on
              target:
                entity_id: switch.laundry_room_boiler_controller_l2
            - service: logbook.log
              data:
                name: "Boiler Control"
                message: >
                  Boiler turned ON - Heating demand: 
                  Living room: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C,
                  Active valves: 
                  {% if state_attr('climate.bedroom_radiator_heat_valve', 'hvac_mode') != 'off' %}Bedroom {% endif %}
                  {% if state_attr('climate.kids_room_radiator_heat_valve', 'hvac_mode') != 'off' %}KidsRoom {% endif %}
                  {% if state_attr('climate.workshop_radiator_heat_valve', 'hvac_mode') != 'off' %}Workshop {% endif %}
                  Downstairs Upstairs 
                  {% if state_attr('climate.entrance_radiator_heat_valve', 'hvac_mode') != 'off' %}Entrance {% endif %}
    # If neither turn-off nor turn-on conditions met, maintain current boiler state (hysteresis dead zone)
    # No else block - intentionally do nothing to prevent oscillation
  mode: single

# Kids Room Dimmer Switch Control
- id: 'kids_room_dimmer_switch_control'
  alias: "Kids Room Dimmer Switch Control"
  description: "Control kids room LED strip with IKEA RODRET wireless dimmer"
  triggers:
    # IKEA RODRET uses device automation - listen to MQTT events
    - platform: mqtt
      topic: zigbee2mqtt/Kids Room Dimmer Switch
      value_template: "{{ value_json.action }}"
  conditions:
    - condition: template
      value_template: "{{ trigger.payload_json.action is defined and trigger.payload_json.action != '' }}"
  actions:
    - choose:
        # ON button press - turn on LED strip
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'on' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
        
        # OFF button press - turn off LED strip  
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'off' }}"
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.kids_room_door_led_strip
        
        # Brightness move up - increase brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_up' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: 20
        
        # Brightness move down - decrease brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_down' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: -20
        
        # Brightness stop - do nothing (just stops dimming)
        # This happens when user releases button after dimming
  mode: restart

# LED Strip Schedule Control
- id: 'led_strips_evening_schedule'
  alias: "LED Strips Evening Schedule"
  description: "Turn on bedroom and kids room LED strips at 7 PM, turn off at 7:30 AM"
  triggers:
    # Turn on at 7 PM
    - platform: time
      at: "19:00:00"
      id: "turn_on"
    # Turn off at 7:30 AM
    - platform: time
      at: "07:30:00"
      id: "turn_off"
  conditions: []
  actions:
    - if:
        - condition: trigger
          id: "turn_on"
      then:
        # Turn on both LED strips at 7 PM
        - service: light.turn_on
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
          data:
            brightness_pct: 30
      else:
        # Turn off both LED strips at 7:30 AM
        - service: light.turn_off
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
  mode: single