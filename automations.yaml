# House-specific automations
# Migrated and cleaned up from current HA setup

# GitOps Deployment Automation
- id: 'zigbee2mqtt_gitops_deploy'
  alias: "Deploy Zigbee2MQTT Configuration from Git"
  description: "Automatically deploy Git-managed Z2M config when changed"
  triggers:
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    - service: shell_command.deploy_zigbee2mqtt_config
      data: {}
    - delay: 5
    - service: hassio.addon_restart
      data:
        addon: 45df7312_zigbee2mqtt
  mode: single

# House Automations
# Location-specific automations for the house

# CO2 Air Quality LED Notifications
- id: 'co2_led_notification'
  alias: "CO2 Air Quality LED Notifications"
  description: "Adjust LED strip colors based on CO2 levels and window states for air quality awareness"
  triggers:
    # Monitor bedroom CO2 levels
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      above: 1500
      id: bedroom_high_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 1500
      above: 800
      id: bedroom_normal_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 800
      id: bedroom_low_co2
    # Monitor window state changes (bedroom and kids room only)
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
      id: window_state_change
  conditions: []
  actions:
    - choose:
        # High CO2 + Windows closed -> Pulse (alert to open windows)
        - conditions:
            - condition: trigger
              id: bedroom_high_co2
            - condition: state
              entity_id: binary_sensor.bedroom_window_sensor_contact
              state: 'off'  # Bedroom window closed
            - condition: state
              entity_id: binary_sensor.kids_room_window_sensor_contact
              state: 'off'  # Kids room window closed
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Low CO2 + Windows open in winter -> Pulse (alert to close windows)
        - conditions:
            - condition: trigger
              id: bedroom_low_co2
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.bedroom_window_sensor_contact
                  state: 'on'  # Bedroom window open
                - condition: state
                  entity_id: binary_sensor.kids_room_window_sensor_contact
                  state: 'on'  # Kids room window open
            # Winter condition: October through March
            - condition: template
              value_template: >
                {% set month = now().month %}
                {{ month >= 10 or month <= 3 }}
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Normal/Low CO2 + Windows closed -> Stop pulsing, return to normal
        - conditions:
            - condition: or
              conditions:
                # Normal CO2 reached
                - condition: trigger
                  id: bedroom_normal_co2
                # Window closed while low CO2
                - condition: and
                  conditions:
                    - condition: trigger
                      id: window_state_change
                    - condition: template
                      value_template: "{{ trigger.to_state.state == 'off' }}"  # Window closed
                    - condition: numeric_state
                      entity_id: sensor.bedroom_co2_sensor_co2
                      below: 800
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # High CO2 + Window opened -> Stop pulsing, return to normal
        - conditions:
            - condition: trigger
              id: window_state_change
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window opened
            - condition: numeric_state
              entity_id: sensor.bedroom_co2_sensor_co2
              above: 1500
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.kids_room_door_led_strip
  mode: queued
  max: 10

# Heat Valve External Temperature Sync
- id: 'heat_valves_external_temperature_sync'
  alias: "Heat Valves External Temperature Sync"
  description: "Configure heat valves to use external sensors for heating control"
  triggers:
    - platform: state
      entity_id: 
        - sensor.bedroom_temperature_sensor_temperature
        - sensor.kids_room_temperature_sensor_temperature
        - sensor.workshop_temperature_sensor_temperature
        - sensor.entrance_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # Configure each valve to use external sensor
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'  
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Sync current temperature readings
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.bedroom_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.kids_room_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.workshop_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.entrance_temperature_sensor_temperature') | float(20) }}}
  mode: single

# Window State Synchronization for All Heat Valves
- id: 'heat_valves_window_sync_all'
  alias: "Heat Valves Window State Sync (All Rooms)"
  description: "Turn off heating when windows open, resume when windows close for all heat valves with window sensors"
  triggers:
    # Monitor all window sensors that have corresponding heat valves
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
        - binary_sensor.workshop_window_sensor_contact
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # Individual window control for each heat valve
    - if:
        - condition: state
          entity_id: binary_sensor.bedroom_window_sensor_contact
          state: 'on'  # Window OPEN
      then:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
    - if:
        - condition: state
          entity_id: binary_sensor.kids_room_window_sensor_contact
          state: 'on'  # Window OPEN
      then:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
    - if:
        - condition: state
          entity_id: binary_sensor.workshop_window_sensor_contact
          state: 'on'  # Window OPEN
      then:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
  mode: single

# Boiler Control Automation
- id: 'boiler_heating_control'
  alias: "Boiler Heating Control"
  description: "Control boiler based on radiator valve demands and living room temperature limits"
  triggers:
    # Monitor all radiator valve states for heating demand
    - platform: state
      entity_id: 
        - climate.bedroom_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.upstairs_bathroom_radiator_heat_valve
    # Monitor living room temperature changes
    - platform: state
      entity_id: sensor.living_room_temperature_sensor_temperature
    # Monitor living room window sensors for safety
    - platform: state
      entity_id: 
        - binary_sensor.kitchen_window_sensor_contact
        - binary_sensor.living_room_door_sensor_contact
    # Startup trigger
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # SAFETY OVERRIDE: Turn off boiler if living room too hot
    - if:
        - condition: template
          value_template: >
            {{ states('sensor.living_room_temperature_sensor_temperature') | float(0) > 25 }}
      then:
        # Turn off boiler - living room overheating
        - service: switch.turn_off
          target:
            entity_id: switch.laundry_room_boiler_controller_l2
        - service: logbook.log
          data:
            name: "Boiler Control"
            message: "Boiler turned OFF - living room temperature above 25°C (current: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C)"
      else:
        # NORMAL OPERATION: Check if heating is needed
        - if:
            - condition: or
              conditions:
                # Any radiator valve calling for heat (hvac_action = heating)
                # Check underlying valve entities since template entities don't expose hvac_action
                - condition: template
                  value_template: >
                    {{ is_state_attr('climate.bedroom_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.kids_room_radiator_heat_valve', 'hvac_action', 'heating') or 
                       is_state_attr('climate.workshop_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.entrance_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') }}
                # OR living room needs heating (only if windows closed)
                - condition: and
                  conditions:
                    # Living room temperature below threshold
                    - condition: template
                      value_template: >
                        {{ states('sensor.living_room_temperature_sensor_temperature') | float(0) < 21 }}
                    # Kitchen window closed (affects living room area)
                    - condition: state
                      entity_id: binary_sensor.kitchen_window_sensor_contact
                      state: 'off'  # Contact sensor OFF = window CLOSED
                    # Living room door closed (garden door)
                    - condition: state
                      entity_id: binary_sensor.living_room_door_sensor_contact
                      state: 'off'  # Contact sensor OFF = door CLOSED
          then:
            # Turn on boiler - heating needed
            - service: switch.turn_on
              target:
                entity_id: switch.laundry_room_boiler_controller_l2
            - service: logbook.log
              data:
                name: "Boiler Control"
                message: >
                  Boiler turned ON - Heating demand: 
                  Living room: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C,
                  Valves heating: 
                  {% if is_state_attr('climate.bedroom_radiator_heat_valve', 'hvac_action', 'heating') %}Bedroom {% endif %}
                  {% if is_state_attr('climate.kids_room_radiator_heat_valve', 'hvac_action', 'heating') %}KidsRoom {% endif %}
                  {% if is_state_attr('climate.workshop_radiator_heat_valve', 'hvac_action', 'heating') %}Workshop {% endif %}
                  {% if is_state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') %}Downstairs {% endif %}
                  {% if is_state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') %}Upstairs {% endif %}
                  {% if is_state_attr('climate.entrance_radiator_heat_valve', 'hvac_action', 'heating') %}Entrance {% endif %}
          else:
            # Turn off boiler - NO heating needed
            - service: switch.turn_off
              target:
                entity_id: switch.laundry_room_boiler_controller_l2
            - service: logbook.log
              data:
                name: "Boiler Control"
                message: "Boiler turned OFF - No heating demand (All valves satisfied, Living room: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C ≥ 22°C)"
  mode: single

# Kids Room Dimmer Switch Control
- id: 'kids_room_dimmer_switch_control'
  alias: "Kids Room Dimmer Switch Control"
  description: "Control kids room LED strip with IKEA RODRET wireless dimmer"
  triggers:
    # IKEA RODRET uses device automation - listen to MQTT events
    - platform: mqtt
      topic: zigbee2mqtt/Kids Room Dimmer Switch
      value_template: "{{ value_json.action }}"
  conditions:
    - condition: template
      value_template: "{{ trigger.payload_json.action is defined and trigger.payload_json.action != '' }}"
  actions:
    - choose:
        # ON button press - turn on LED strip
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'on' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
        
        # OFF button press - turn off LED strip  
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'off' }}"
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.kids_room_door_led_strip
        
        # Brightness move up - increase brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_up' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: 20
        
        # Brightness move down - decrease brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_down' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: -20
        
        # Brightness stop - do nothing (just stops dimming)
        # This happens when user releases button after dimming
  mode: restart

# LED Strip Schedule Control
- id: 'led_strips_evening_schedule'
  alias: "LED Strips Evening Schedule"
  description: "Turn on bedroom and kids room LED strips at 7 PM, turn off at 7 AM"
  triggers:
    # Turn on at 7 PM
    - platform: time
      at: "19:00:00"
      id: "turn_on"
    # Turn off at 7 AM  
    - platform: time
      at: "07:00:00"
      id: "turn_off"
  conditions: []
  actions:
    - if:
        - condition: trigger
          id: "turn_on"
      then:
        # Turn on both LED strips at 7 PM
        - service: light.turn_on
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
          data:
            brightness_pct: 30
      else:
        # Turn off both LED strips at 7 AM
        - service: light.turn_off
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
  mode: single