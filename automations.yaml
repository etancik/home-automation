# House-specific automations
# Migrated and cleaned up from current HA setup

# GitOps Deployment Automation
- id: 'zigbee2mqtt_gitops_deploy'
  alias: "Deploy Zigbee2MQTT Configuration from Git"
  description: "Automatically deploy Git-managed Z2M config when changed"
  triggers:
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    - service: shell_command.deploy_zigbee2mqtt_config
      data: {}
    - delay: 5
    - service: hassio.addon_restart
      data:
        addon: 45df7312_zigbee2mqtt
  mode: single

# House Automations
# Location-specific automations for the house

# CO2 Air Quality LED Notifications
- id: 'co2_led_notification'
  alias: "CO2 Air Quality LED Notifications"
  description: "Adjust LED strip colors based on CO2 levels and window states for air quality awareness"
  triggers:
    # Monitor bedroom CO2 levels
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      above: 1500
      id: bedroom_high_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 1500
      above: 800
      id: bedroom_normal_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 800
      id: bedroom_low_co2
    # Monitor window state changes (bedroom and kids room only)
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
      id: window_state_change
  conditions: []
  actions:
    - choose:
        # High CO2 + Windows closed -> Pulse (alert to open windows)
        - conditions:
            - condition: trigger
              id: bedroom_high_co2
            - condition: state
              entity_id: binary_sensor.bedroom_window_sensor_contact
              state: 'off'  # Bedroom window closed
            - condition: state
              entity_id: binary_sensor.kids_room_window_sensor_contact
              state: 'off'  # Kids room window closed
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Low CO2 + Windows open in winter -> Pulse (alert to close windows)
        - conditions:
            - condition: trigger
              id: bedroom_low_co2
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.bedroom_window_sensor_contact
                  state: 'on'  # Bedroom window open
                - condition: state
                  entity_id: binary_sensor.kids_room_window_sensor_contact
                  state: 'on'  # Kids room window open
            # Winter condition: October through March
            - condition: template
              value_template: >
                {% set month = now().month %}
                {{ month >= 10 or month <= 3 }}
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_pulse_current_color
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Normal/Low CO2 + Windows closed -> Stop pulsing, return to normal
        - conditions:
            - condition: or
              conditions:
                # Normal CO2 reached
                - condition: trigger
                  id: bedroom_normal_co2
                # Window closed while low CO2
                - condition: and
                  conditions:
                    - condition: trigger
                      id: window_state_change
                    - condition: template
                      value_template: "{{ trigger.to_state.state == 'off' }}"  # Window closed
                    - condition: numeric_state
                      entity_id: sensor.bedroom_co2_sensor_co2
                      below: 800
          sequence:
            # Note: LED breathing effects now automatically restore original state
            # No manual restoration needed for low CO2 notification
        
        # High CO2 + Window opened -> Stop pulsing, return to normal
        - conditions:
            - condition: trigger
              id: window_state_change
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window opened
            - condition: numeric_state
              entity_id: sensor.bedroom_co2_sensor_co2
              above: 1500
          sequence:
            # Note: LED breathing effects now automatically restore original state  
            # No manual restoration needed when windows open
  mode: queued
  max: 10

# Heat Valve External Temperature Sync
- id: 'heat_valves_external_temperature_sync'
  alias: "Heat Valves External Temperature Sync"
  description: "Configure heat valves to use external sensors for heating control"
  triggers:
    - platform: state
      entity_id: 
        - sensor.bedroom_temperature_sensor_temperature
        - sensor.kids_room_temperature_sensor_temperature
        - sensor.workshop_temperature_sensor_temperature
        - sensor.entrance_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    # Only run if all temperature sensors are available
    - condition: template
      value_template: >
        {{ states('sensor.bedroom_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.kids_room_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.workshop_temperature_sensor_temperature') not in ['unknown', 'unavailable']
           and states('sensor.entrance_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}
  actions:
    # Wait for Zigbee2MQTT to initialize after startup
    - delay:
        seconds: 30
    # Configure each valve: external sensor + minimal 0.2°C hysteresis for centralized boiler control
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external", "temperature_accuracy": -0.2}'
    # Configure bathroom valves with minimal hysteresis
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Downstairs Bathroom Radiator Heat Valve/set"
        payload: '{"temperature_accuracy": -0.2}'
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Upstairs Bathroom Radiator Heat Valve/set"
        payload: '{"temperature_accuracy": -0.2}'
    # Sync current temperature readings
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.bedroom_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.kids_room_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.workshop_temperature_sensor_temperature') | float(20) }}}
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.entrance_temperature_sensor_temperature') | float(20) }}}
  mode: queued
  max: 5

# Window State Synchronization for All Heat Valves
- id: 'heat_valves_window_sync_all'
  alias: "Heat Valves Window State Sync (All Rooms)"
  description: "Turn off heating when windows open, resume when windows close for all heat valves with window sensors"
  triggers:
    # Monitor all window sensors that have corresponding heat valves
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.entrance_door_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
        - binary_sensor.workshop_window_sensor_contact
  conditions: []
  actions:
    # Only process the room that triggered this automation
    - variables:
        room_map:
          binary_sensor.bedroom_window_sensor_contact:
            name: "Bedroom"
            valve: "Bedroom Radiator Heat Valve"
          binary_sensor.entrance_door_sensor_contact:
            name: "Entrance"
            valve: "Entrance Radiator Heat Valve"
          binary_sensor.kids_room_window_sensor_contact:
            name: "Kids Room"
            valve: "Kids Room Radiator Heat Valve"
          binary_sensor.workshop_window_sensor_contact:
            name: "Workshop"
            valve: "Workshop Radiator Heat Valve"
    - variables:
        room_config: "{{ room_map[trigger.entity_id] }}"
    # Check if sensor is available
    - if:
        - condition: template
          value_template: "{{ trigger.to_state.state in ['unknown', 'unavailable'] }}"
      then:
        - service: logbook.log
          data:
            name: "Heat Valve Window Sync"
            message: "{{ room_config.name }} sensor offline - skipping heating control"
      else:
        # Sensor available - control heating based on state
        - if:
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window/Door OPEN
          then:
            - service: mqtt.publish
              data:
                topic: "zigbee2mqtt/{{ room_config.valve }}/set"
                payload: '{"system_mode": "off"}'
            - service: logbook.log
              data:
                name: "Heat Valve Window Sync"
                message: "{{ room_config.name }} window/door opened - heating turned OFF"
          else:
            - service: mqtt.publish
              data:
                topic: "zigbee2mqtt/{{ room_config.valve }}/set"
                payload: '{"system_mode": "heat"}'
            - service: logbook.log
              data:
                name: "Heat Valve Window Sync"
                message: "{{ room_config.name }} window/door closed - heating resumed"
  mode: queued
  max: 5

# Floor Heating Window/Door State Synchronization
- id: 'floor_heating_window_sync'
  alias: "Floor Heating Window/Door Sync"
  description: "Turn off floor heating when windows/doors open, resume when closed"
  triggers:
    # Monitor kitchen window and living room door for Living Room floor heating zone
    - platform: state
      entity_id: 
        - binary_sensor.kitchen_window_sensor_contact
        - binary_sensor.living_room_door_sensor_contact
  conditions: []
  actions:
    # Living Room floor heating zone affected by both kitchen window and living room door
    - variables:
        # Check if EITHER kitchen window OR living room door is open
        any_opening_open: >
          {{ is_state('binary_sensor.kitchen_window_sensor_contact', 'on') or 
             is_state('binary_sensor.living_room_door_sensor_contact', 'on') }}
    - if:
        - condition: template
          value_template: "{{ any_opening_open }}"
      then:
        # Turn OFF Living Room floor heating when any opening is open
        - service: climate.turn_off
          target:
            entity_id: climate.living_room_floor_heating
        - service: logbook.log
          data:
            name: "Floor Heating Window Sync"
            message: >
              Living Room floor heating turned OFF - 
              Kitchen window: {{ states('binary_sensor.kitchen_window_sensor_contact') }}, 
              Living room door: {{ states('binary_sensor.living_room_door_sensor_contact') }}
      else:
        # Turn ON Living Room floor heating when both openings are closed
        - service: climate.turn_on
          target:
            entity_id: climate.living_room_floor_heating
        - service: logbook.log
          data:
            name: "Floor Heating Window Sync"
            message: "Living Room floor heating resumed - all openings closed"
  mode: single

# Boiler Control Automation
#
# TWO-LEVEL HYSTERESIS SYSTEM:
#
# Level 1 - VALVE/ACTUATOR (0.2°C hysteresis):
#   - Radiator valves: Open/close with tight 0.2°C hysteresis (built into SONOFF TRVZB)
#   - Floor heating actuators: Zigbee Aqara switches with thermo valves (0.2°C hysteresis)
#   - These respond QUICKLY to temperature changes
#
# Level 2 - BOILER (1.0°C hysteresis):
#   - Boiler turns ON when: current_temp < target_temp - 1.0°C (any zone)
#   - Boiler turns OFF when: all valves/actuators report NOT heating (hvac_action != 'heating')
#   - This responds SLOWLY to prevent short cycling
#
# HOW IT WORKS:
#   - Valves/actuators can open anytime based on local temperature
#   - Boiler only runs when ANY zone is significantly cold (1.0°C below target)
#   - Open valves take advantage of hot water when boiler is running
#   - Result: Valves respond fast, boiler cycles slowly, energy efficient
#
- id: 'boiler_heating_control'
  alias: "Boiler Heating Control"
  description: "Control boiler based on radiator valve and floor heating zone demands"
  triggers:
    # Monitor all radiator valve states for heating demand
    - platform: state
      entity_id: 
        - climate.bedroom_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.upstairs_bathroom_radiator_heat_valve
    # Monitor temperature sensors for floor heating zones
    - platform: state
      entity_id:
        - sensor.living_room_temperature_sensor_temperature
    # Monitor boiler state changes
    - platform: state
      entity_id: switch.laundry_room_boiler_controller_l2
    # Monitor floor heating actuator switches (ground truth)
    - platform: state
      entity_id:
        - switch.floor_heating_controller_l1
        - switch.floor_heating_controller_l2
    # Startup trigger
    - platform: homeassistant
      event: start
      id: start
  conditions:
    # ONLY block if boiler controller itself is unavailable
    # Individual sensor failures are handled per-zone in the logic below
    - condition: template
      value_template: >
        {{ states('switch.laundry_room_boiler_controller_l2') not in ['unknown', 'unavailable'] }}
  actions:
    # Wait for Zigbee2MQTT to initialize after startup
    - if:
        - condition: trigger
          id: start
      then:
        - delay:
            seconds: 30
    
    # DIAGNOSTIC: Log current state - CRITICAL: Compare hvac_action vs actual switch state
    - service: system_log.write
      data:
        level: info
        logger: homeassistant.components.automation.boiler_heating_control
        message: >
          BOILER DEBUG: LR={{ states('sensor.living_room_temperature_sensor_temperature') }}°C/{{ state_attr('climate.living_room_floor_heating', 'temperature') }}°C [action={{ state_attr('climate.living_room_floor_heating', 'hvac_action') }} L1={{ states('switch.floor_heating_controller_l1') }}]
          | Bedroom={{ states('sensor.bedroom_temperature_sensor_temperature') }}°C/{{ state_attr('climate.bedroom_radiator_heat_valve', 'temperature') }}°C [{{ state_attr('climate.bedroom_radiator_heat_valve', 'hvac_mode') }}]
          | Kids={{ states('sensor.kids_room_temperature_sensor_temperature') }}°C/{{ state_attr('climate.kids_room_radiator_heat_valve', 'temperature') }}°C [{{ state_attr('climate.kids_room_radiator_heat_valve', 'hvac_mode') }}]
          | Workshop={{ states('sensor.workshop_temperature_sensor_temperature') }}°C/{{ state_attr('climate.workshop_radiator_heat_valve', 'temperature') }}°C [{{ state_attr('climate.workshop_radiator_heat_valve', 'hvac_mode') }}]
          | Entrance={{ states('sensor.entrance_temperature_sensor_temperature') }}°C/{{ state_attr('climate.entrance_radiator_heat_valve', 'temperature') }}°C [{{ state_attr('climate.entrance_radiator_heat_valve', 'hvac_mode') }}]
          | Bath Down Floor [action={{ state_attr('climate.downstairs_bathroom_floor_heating', 'hvac_action') }} L2={{ states('switch.floor_heating_controller_l2') }}]
          | Boiler={{ states('switch.laundry_room_boiler_controller_l2') }}
    
    # Define zones: All climate entities need Level 2 (1.0°C) check for boiler turn-on
    - variables:
        heating_zones:
          - climate.bedroom_radiator_heat_valve
          - climate.kids_room_radiator_heat_valve
          - climate.workshop_radiator_heat_valve
          - climate.entrance_radiator_heat_valve
          - climate.downstairs_bathroom_radiator_heat_valve
          - climate.upstairs_bathroom_radiator_heat_valve
          - climate.living_room_floor_heating
          - climate.downstairs_bathroom_floor_heating
        floor_switches:
          - switch.floor_heating_controller_l1
          - switch.floor_heating_controller_l2
    
    # EVALUATE TURN OFF FIRST: Check if all zones satisfied
    - if:
        - condition: template
          value_template: >
            {% set ns = namespace(heating_count=0) %}
            {# Check all heating zones (radiators + floor) - count those actively heating #}
            {% for zone in heating_zones %}
              {% if state_attr(zone, 'hvac_mode') != 'off' and state_attr(zone, 'hvac_action') == 'heating' %}
                {% set ns.heating_count = ns.heating_count + 1 %}
              {% endif %}
            {% endfor %}
            {# Check floor heating switches (ground truth) #}
            {% for switch in floor_switches %}
              {% if is_state(switch, 'on') %}
                {% set ns.heating_count = ns.heating_count + 1 %}
              {% endif %}
            {% endfor %}
            {{ ns.heating_count == 0 }}
      then:
        # Turn off boiler - heating complete
        - service: switch.turn_off
          target:
            entity_id: switch.laundry_room_boiler_controller_l2
        - service: system_log.write
          data:
            level: info
            logger: homeassistant.components.automation.boiler_heating_control
            message: "BOILER OFF: All zones satisfied (radiators + floor heating actuators OFF)"
        # Wait briefly to allow state to propagate
        - delay:
            seconds: 2
        # VERIFY boiler actually turned off - log error if stuck
        - if:
            - condition: state
              entity_id: switch.laundry_room_boiler_controller_l2
              state: 'on'
          then:
            - service: system_log.write
              data:
                level: error
                logger: homeassistant.components.automation.boiler_heating_control
                message: "CRITICAL: Boiler failed to turn OFF! Switch may be stuck or relay failure."
        - stop: ""
    
    # EVALUATE TURN ON: Check if ANY zone needs heating
    - if:
        - condition: template
          value_template: >
            {% set ns = namespace(needs_heat=false) %}
            
            {# All zones: current_temp < target_temp - 1.0°C (Level 2 hysteresis) #}
            {% for zone in heating_zones %}
              {% if state_attr(zone, 'hvac_mode') != 'off' %}
                {% set current = state_attr(zone, 'current_temperature') | float(20) %}
                {% set target = state_attr(zone, 'temperature') | float(20) %}
                {% if current < (target - 1.0) %}
                  {% set ns.needs_heat = true %}
                {% endif %}
              {% endif %}
            {% endfor %}
            
            {{ ns.needs_heat }}
      then:
        # Turn on boiler - heating needed
        - service: switch.turn_on
          target:
            entity_id: switch.laundry_room_boiler_controller_l2
        - service: system_log.write
          data:
            level: info
            logger: homeassistant.components.automation.boiler_heating_control
            message: >
              BOILER ON: LR={{ states('sensor.living_room_temperature_sensor_temperature') }}°C [L1={{ states('switch.floor_heating_controller_l1') }}]
              | Bedroom={{ states('sensor.bedroom_temperature_sensor_temperature') }}°C/{{ state_attr('climate.bedroom_radiator_heat_valve', 'temperature') }}°C
              | Floor L2={{ states('switch.floor_heating_controller_l2') }}
        # Wait briefly to allow state to propagate
        - delay:
            seconds: 2
        # VERIFY boiler actually turned on - log error if stuck
        - if:
            - condition: state
              entity_id: switch.laundry_room_boiler_controller_l2
              state: 'off'
          then:
            - service: system_log.write
              data:
                level: error
                logger: homeassistant.components.automation.boiler_heating_control
                message: "CRITICAL: Boiler failed to turn ON! Switch may be stuck or relay failure."
    # If neither turn-off nor turn-on conditions met, maintain current boiler state (hysteresis dead zone)
    # No else block - intentionally do nothing to prevent oscillation
  mode: single

# Kids Room Dimmer Switch Control
- id: 'kids_room_dimmer_switch_control'
  alias: "Kids Room Dimmer Switch Control"
  description: "Control kids room LED strip with IKEA RODRET wireless dimmer"
  triggers:
    # IKEA RODRET uses device automation - listen to MQTT events
    - platform: mqtt
      topic: zigbee2mqtt/Kids Room Dimmer Switch
      value_template: "{{ value_json.action }}"
  conditions:
    - condition: template
      value_template: "{{ trigger.payload_json.action is defined and trigger.payload_json.action != '' }}"
  actions:
    - choose:
        # ON button press - turn on LED strip
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'on' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
        
        # OFF button press - turn off LED strip  
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'off' }}"
          sequence:
            - service: light.turn_off
              target:
                entity_id: light.kids_room_door_led_strip
        
        # Brightness move up - increase brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_up' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: 20
        
        # Brightness move down - decrease brightness
        - conditions:
            - condition: template
              value_template: "{{ trigger.payload_json.action == 'brightness_move_down' }}"
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: -20
        
        # Brightness stop - do nothing (just stops dimming)
        # This happens when user releases button after dimming
  mode: restart

# LED Strip Schedule Control
- id: 'led_strips_evening_schedule'
  alias: "LED Strips Evening Schedule"
  description: "Turn on bedroom and kids room LED strips at 7 PM, turn off at 7:30 AM"
  triggers:
    # Turn on at 7 PM
    - platform: time
      at: "19:00:00"
      id: "turn_on"
    # Turn off at 7:30 AM
    - platform: time
      at: "07:30:00"
      id: "turn_off"
  conditions: []
  actions:
    - if:
        - condition: trigger
          id: "turn_on"
      then:
        # Turn on both LED strips at 7 PM
        - service: light.turn_on
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
          data:
            brightness_pct: 30
      else:
        # Turn off both LED strips at 7:30 AM
        - service: light.turn_off
          target:
            entity_id:
              - light.bedroom_led_strip
              - light.kids_room_door_led_strip
  mode: single