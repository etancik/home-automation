# Heat Valve External Temperature Synchronization
# Syncs external temperature sensors to their corresponding heat valves

# Bedroom Heat Valve Temperature Sync
bedroom_heat_valve_temperature_sync:
  alias: "Bedroom Heat Valve Temperature Sync"
  description: "Sync external temperature sensor reading to bedroom heat valve"
  trigger:
    - platform: state
      entity_id: sensor.bedroom_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  condition:
    - condition: template
      value_template: "{{ states('sensor.bedroom_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}"
  action:
    # Set valve to use external temperature sensor
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Sync the temperature value
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.bedroom_temperature_sensor_temperature') | float }}}
  mode: single