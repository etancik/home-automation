# House-specific automations
# Migrated and cleaned up from current HA setup

# GitOps Deployment Automation
- id: 'zigbee2mqtt_gitops_deploy'
  alias: "Deploy Zigbee2MQTT Configuration from Git"
  description: "Automatically deploy Git-managed Z2M config when changed"
  triggers:
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    - service: shell_command.deploy_zigbee2mqtt_config
      data: {}
    - delay: 5
    - service: hassio.addon_restart
      data:
        addon: 45df7312_zigbee2mqtt
  mode: single

# House Automations
# Location-specific automations for the house

# CO2 Air Quality LED Notifications
- id: 'co2_led_notification'
  alias: "CO2 Air Quality LED Notifications"
  description: "Adjust LED strip colors based on CO2 levels and window states for air quality awareness"
  triggers:
    # Monitor bedroom CO2 levels
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      above: 1200
      id: bedroom_high_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 1200
      above: 800
      id: bedroom_normal_co2
    - platform: numeric_state
      entity_id: sensor.bedroom_co2_sensor_co2
      below: 800
      id: bedroom_low_co2
    # Monitor window state changes (bedroom and kids room only)
    - platform: state
      entity_id: 
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
      id: window_state_change
  conditions: []
  actions:
    - choose:
        # High CO2 - Red pulse (only if LED is on AND windows are closed)
        - conditions:
            - condition: trigger
              id: bedroom_high_co2
            - condition: state
              entity_id: binary_sensor.bedroom_window_sensor_contact
              state: 'off'  # Bedroom window closed
            - condition: state
              entity_id: binary_sensor.kids_room_window_sensor_contact
              state: 'off'  # Kids room window closed
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_red_pulse
                  data:
                    entity_id: light.bedroom_led_strip
                    co2_level: "{{ states('sensor.bedroom_co2_sensor_co2') | int }}"
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_red_pulse
                  data:
                    entity_id: light.kids_room_door_led_strip
                    co2_level: "{{ states('sensor.bedroom_co2_sensor_co2') | int }}"
        
        # Window opened while CO2 high - immediately restore normal
        - conditions:
            - condition: trigger
              id: window_state_change
            - condition: template
              value_template: "{{ trigger.to_state.state == 'on' }}"  # Window opened
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{ trigger.entity_id == 'binary_sensor.bedroom_window_sensor_contact' }}"
                - condition: template
                  value_template: "{{ trigger.entity_id == 'binary_sensor.kids_room_window_sensor_contact' }}"
          sequence:
            - if:
                - condition: numeric_state
                  entity_id: sensor.bedroom_co2_sensor_co2
                  above: 1200
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: numeric_state
                  entity_id: sensor.bedroom_co2_sensor_co2
                  above: 1200
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  data:
                    entity_id: light.kids_room_door_led_strip
        
        # Normal CO2 - Restore original color
        - conditions:
            - condition: trigger
              id: bedroom_normal_co2
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  target:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  target:
                    entity_id: light.kids_room_door_led_strip
        
        # Low CO2 + windows open in winter - Green pulse (ventilation working!)
        - conditions:
            - condition: trigger
              id: bedroom_low_co2
            - condition: or
              conditions:
                - condition: state
                  entity_id: binary_sensor.bedroom_window_sensor_contact
                  state: 'on'  # Bedroom window open
                - condition: state
                  entity_id: binary_sensor.kids_room_window_sensor_contact
                  state: 'on'  # Kids room window open
            # Winter condition: October through March
            - condition: template
              value_template: >
                {% set month = now().month %}
                {{ month >= 10 or month <= 3 }}
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_green_pulse
                  target:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_green_pulse
                  target:
                    entity_id: light.kids_room_door_led_strip
        
        # Window closed after green pulse - restore normal
        - conditions:
            - condition: trigger
              id: window_state_change
            - condition: template
              value_template: "{{ trigger.to_state.state == 'off' }}"  # Window closed
            - condition: or
              conditions:
                - condition: template
                  value_template: "{{ trigger.entity_id == 'binary_sensor.bedroom_window_sensor_contact' }}"
                - condition: template
                  value_template: "{{ trigger.entity_id == 'binary_sensor.kids_room_window_sensor_contact' }}"
            - condition: numeric_state
              entity_id: sensor.bedroom_co2_sensor_co2
              below: 800
          sequence:
            - if:
                - condition: state
                  entity_id: light.bedroom_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  target:
                    entity_id: light.bedroom_led_strip
            - if:
                - condition: state
                  entity_id: light.kids_room_door_led_strip
                  state: 'on'
              then:
                - service: script.co2_led_restore_normal
                  target:
                    entity_id: light.kids_room_door_led_strip
  mode: queued
  max: 10

# Heat Valve External Temperature Synchronization  
- id: 'bedroom_radiator_heat_valve_temperature_sync'
  alias: "Bedroom Radiator Heat Valve Temperature Sync"
  description: "Sync external temperature sensor reading to bedroom radiator heat valve"
  triggers:
    - platform: state
      entity_id: sensor.bedroom_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    - condition: template
      value_template: "{{ states('sensor.bedroom_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}"
  actions:
    # Set valve to use external temperature sensor only
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Disable internal temperature sensor completely
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: '{"local_temperature_calibration": 0}'
    # Sync the external temperature value
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.bedroom_temperature_sensor_temperature') | float }}}
  mode: single

# Heat Valve Window State Synchronization
- id: 'bedroom_radiator_heat_valve_window_sync'
  alias: "Bedroom Radiator Heat Valve Window Sync"
  description: "Turn off heating when window opens, resume when window closes"
  triggers:
    - platform: state
      entity_id: binary_sensor.bedroom_window_sensor_contact
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # When window is OPEN - turn off heating
    - if:
        - condition: state
          entity_id: binary_sensor.bedroom_window_sensor_contact
          state: 'on'  # Contact sensor ON = window OPEN (inverted logic)
      then:
        # Turn off heating completely
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        # When window is CLOSED - resume normal heating
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Bedroom Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
  mode: single

# Kids Room Heat Valve External Temperature Synchronization  
- id: 'kids_room_radiator_heat_valve_temperature_sync'
  alias: "Kids Room Radiator Heat Valve Temperature Sync"
  description: "Sync external temperature sensor reading to kids room radiator heat valve"
  triggers:
    - platform: state
      entity_id: sensor.kids_room_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    - condition: template
      value_template: "{{ states('sensor.kids_room_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}"
  actions:
    # Set valve to use external temperature sensor only
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Disable internal temperature sensor completely
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: '{"local_temperature_calibration": 0}'
    # Sync the external temperature value
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.kids_room_temperature_sensor_temperature') | float }}}
  mode: single

# Kids Room Heat Valve Window State Synchronization
- id: 'kids_room_radiator_heat_valve_window_sync'
  alias: "Kids Room Radiator Heat Valve Window Sync"
  description: "Turn off heating when window opens, resume when window closes"
  triggers:
    - platform: state
      entity_id: binary_sensor.kids_room_window_sensor_contact
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # When window is OPEN - turn off heating
    - if:
        - condition: state
          entity_id: binary_sensor.kids_room_window_sensor_contact
          state: 'on'  # Contact sensor ON = window OPEN (inverted logic)
      then:
        # Turn off heating completely
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        # When window is CLOSED - resume normal heating
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Kids Room Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
  mode: single

# Workshop Heat Valve External Temperature Synchronization  
- id: 'workshop_radiator_heat_valve_temperature_sync'
  alias: "Workshop Radiator Heat Valve Temperature Sync"
  description: "Sync external temperature sensor reading to workshop radiator heat valve"
  triggers:
    - platform: state
      entity_id: sensor.workshop_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    - condition: template
      value_template: "{{ states('sensor.workshop_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}"
  actions:
    # Set valve to use external temperature sensor only
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Disable internal temperature sensor completely
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: '{"local_temperature_calibration": 0}'
    # Sync the external temperature value
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.workshop_temperature_sensor_temperature') | float }}}
  mode: single

# Workshop Heat Valve Window State Synchronization
- id: 'workshop_radiator_heat_valve_window_sync'
  alias: "Workshop Radiator Heat Valve Window Sync"
  description: "Turn off heating when window opens, resume when window closes"
  triggers:
    - platform: state
      entity_id: binary_sensor.workshop_window_sensor_contact
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # When window is OPEN - turn off heating
    - if:
        - condition: state
          entity_id: binary_sensor.workshop_window_sensor_contact
          state: 'on'  # Contact sensor ON = window OPEN (inverted logic)
      then:
        # Turn off heating completely
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
            payload: '{"system_mode": "off"}'
      else:
        # When window is CLOSED - resume normal heating
        - service: mqtt.publish
          data:
            topic: "zigbee2mqtt/Workshop Radiator Heat Valve/set"
            payload: '{"system_mode": "heat"}'
  mode: single

# Entrance Heat Valve External Temperature Synchronization  
- id: 'entrance_radiator_heat_valve_temperature_sync'
  alias: "Entrance Radiator Heat Valve Temperature Sync"
  description: "Sync external temperature sensor reading to entrance radiator heat valve"
  triggers:
    - platform: state
      entity_id: sensor.entrance_temperature_sensor_temperature
    - platform: homeassistant
      event: start
  conditions:
    - condition: template
      value_template: "{{ states('sensor.entrance_temperature_sensor_temperature') not in ['unknown', 'unavailable'] }}"
  actions:
    # Set valve to use external temperature sensor only
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: '{"temperature_sensor_select": "external"}'
    # Disable internal temperature sensor completely
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: '{"local_temperature_calibration": 0}'
    # Sync the external temperature value
    - service: mqtt.publish
      data:
        topic: "zigbee2mqtt/Entrance Radiator Heat Valve/set"
        payload: >
          {"external_temperature_input": {{ states('sensor.entrance_temperature_sensor_temperature') | float }}}
  mode: single

# Boiler Control Automation
- id: 'boiler_heating_control'
  alias: "Boiler Heating Control"
  description: "Control boiler based on radiator valve demands and living room temperature limits"
  triggers:
    # Monitor all radiator valve states for heating demand
    - platform: state
      entity_id: 
        - climate.bedroom_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.upstairs_bathroom_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
    # Monitor living room temperature changes
    - platform: state
      entity_id: sensor.living_room_temperature_sensor_temperature
    # Startup trigger
    - platform: homeassistant
      event: start
  conditions: []
  actions:
    # SAFETY OVERRIDE: Turn off boiler if living room too hot
    - if:
        - condition: template
          value_template: >
            {{ states('sensor.living_room_temperature_sensor_temperature') | float(0) > 25 }}
      then:
        # Turn off boiler - living room overheating
        - service: switch.turn_off
          target:
            entity_id: switch.laundry_room_boiler_controller_l2
        - service: logbook.log
          data:
            name: "Boiler Control"
            message: "Boiler turned OFF - living room temperature above 25°C (current: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C)"
      else:
        # NORMAL OPERATION: Check if heating is needed
        - if:
            - condition: or
              conditions:
                # Any radiator valve calling for heat (hvac_action = heating)
                - condition: template
                  value_template: >
                    {{ is_state_attr('climate.bedroom_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.kids_room_radiator_heat_valve', 'hvac_action', 'heating') or 
                       is_state_attr('climate.workshop_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') or
                       is_state_attr('climate.entrance_radiator_heat_valve', 'hvac_action', 'heating') }}
                # OR living room needs heating
                - condition: template
                  value_template: >
                    {{ states('sensor.living_room_temperature_sensor_temperature') | float(0) < 21 }}
          then:
            # Turn on boiler - heating needed
            - service: switch.turn_on
              target:
                entity_id: switch.laundry_room_boiler_controller_l2
            - service: logbook.log
              data:
                name: "Boiler Control"
                message: >
                  Boiler turned ON - Heating demand: 
                  Living room: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C,
                  Valves heating: 
                  {% if is_state_attr('climate.bedroom_radiator_heat_valve', 'hvac_action', 'heating') %}Bedroom {% endif %}
                  {% if is_state_attr('climate.kids_room_radiator_heat_valve', 'hvac_action', 'heating') %}KidsRoom {% endif %}
                  {% if is_state_attr('climate.workshop_radiator_heat_valve', 'hvac_action', 'heating') %}Workshop {% endif %}
                  {% if is_state_attr('climate.downstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') %}Downstairs {% endif %}
                  {% if is_state_attr('climate.upstairs_bathroom_radiator_heat_valve', 'hvac_action', 'heating') %}Upstairs {% endif %}
                  {% if is_state_attr('climate.entrance_radiator_heat_valve', 'hvac_action', 'heating') %}Entrance {% endif %}
          else:
            # Turn off boiler - NO heating needed
            - service: switch.turn_off
              target:
                entity_id: switch.laundry_room_boiler_controller_l2
            - service: logbook.log
              data:
                name: "Boiler Control"
                message: "Boiler turned OFF - No heating demand (All valves satisfied, Living room: {{ states('sensor.living_room_temperature_sensor_temperature') }}°C ≥ 22°C)"
  mode: single

# Kids Room Dimmer Switch Control
- id: 'kids_room_dimmer_switch_control'
  alias: "Kids Room Dimmer Switch Control"
  description: "Control kids room LED strip with IKEA RODRET wireless dimmer"
  triggers:
    - platform: state
      entity_id: sensor.kids_room_dimmer_switch_action
  conditions:
    - condition: template
      value_template: "{{ trigger.to_state.state != 'None' and trigger.to_state.state != '' }}"
  actions:
    - choose:
        # Single press - toggle on/off
        - conditions:
            - condition: state
              entity_id: sensor.kids_room_dimmer_switch_action
              state: 'on'
          sequence:
            - service: light.toggle
              target:
                entity_id: light.kids_room_door_led_strip
        
        # Brightness up - increase brightness
        - conditions:
            - condition: state
              entity_id: sensor.kids_room_dimmer_switch_action
              state: 'brightness_up'
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: 20
        
        # Brightness down - decrease brightness
        - conditions:
            - condition: state
              entity_id: sensor.kids_room_dimmer_switch_action
              state: 'brightness_down'
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_step_pct: -20
        
        # Long press - set to red night light
        - conditions:
            - condition: state
              entity_id: sensor.kids_room_dimmer_switch_action
              state: 'on_hold'
          sequence:
            - service: light.turn_on
              target:
                entity_id: light.kids_room_door_led_strip
              data:
                brightness_pct: 30
                rgb_color: [255, 0, 0]  # Pure red
  mode: restart