# Home Assistant Configuration - House Location
# GitOps managed via Git Pull add-on

# Basic Home Assistant configuration
homeassistant:
  # Name of the location
  name: "House"
  # Location coordinates (Prague defaults - update secrets.yaml with real values)
  latitude: !secret house_latitude
  longitude: !secret house_longitude
  elevation: !secret house_elevation
  # Unit system and locale
  unit_system: metric
  country: CZ
  time_zone: Europe/Prague
  currency: CZK
  # Core shared packages
  packages: !include_dir_named ../../core/packages
  # Location customizations
  customize: !include customize.yaml

# Loads default set of integrations
# Note: default_config does not support exclude parameters in current HA version
# USB discovery is now controlled via integration settings instead
default_config:

# Load frontend themes from the themes folder  
frontend:
  themes: !include_dir_merge_named themes

# Note: MQTT integration is configured via UI (Settings > Devices & Services)
# The Zigbee2MQTT add-on will automatically configure MQTT discovery

# Core configuration files
automation: !include automations.yaml
script: !include scripts.yaml  
scene: !include scenes.yaml

# Heating Control Configuration
input_number:
  living_room_shutoff_temp:
    name: "Living Room Emergency Shutoff"
    min: 15
    max: 30
    initial: 25
    step: 1
    unit_of_measurement: "°C"
    icon: mdi:thermometer-alert

input_boolean:
  living_room_override:
    name: "Ignore Living Room Temperature"
    initial: false
    icon: mdi:fire

# Template switch for display-only living room heating status
# Shows heating when living room temperature is below target and boiler is on
template:
  - switch:
      - name: "Living Room Heating Status"
        unique_id: living_room_heating_status
        # Show heating when:
        # 1. Living room temp is below target (heating requested)
        # 2. Boiler is actually on
        state: >
          {% set current_temp = states('sensor.living_room_temperature_sensor_temperature') | float(25) %}
          {% set target_temp = state_attr('climate.living_room_virtual_heating', 'temperature') | float(21) %}
          {% set boiler_on = is_state('switch.laundry_room_boiler_controller_l2', 'on') %}
          {{ current_temp < target_temp and boiler_on }}
        # Do nothing when turned on/off - automation controls the real boiler
        turn_on:
          - service: system_log.write
            data:
              message: "Living room heating status switch is display-only"
              level: debug
        turn_off:
          - service: system_log.write
            data:
              message: "Living room heating status switch is display-only"
              level: debug
        icon: mdi:radiator

# Virtual thermostat for living room using dummy switch
# Provides HomeKit interface without directly controlling boiler
climate:
  - platform: generic_thermostat
    name: "Living Room Virtual Heating"
    unique_id: living_room_heating
    heater: switch.living_room_heating_status
    target_sensor: sensor.living_room_temperature_sensor_temperature
    min_temp: 4
    max_temp: 35
    target_temp: 21
    cold_tolerance: 0.3
    hot_tolerance: 0.3
    # Start in heat mode - keeps thermostat enabled after restart
    initial_hvac_mode: "heat"

# Garage Door Cover Configuration
# Uses Hörmann Promatic 3 status feedback via Shelly Plus1PM
# The garage door controller reports actual door position (closed/not closed)
cover:
  - platform: template
    covers:
      garage_door:
        friendly_name: "Garage Door"
        device_class: garage
        # Use actual door position from Hörmann via Shelly binary sensor
        # binary_sensor.door_lock reports actual door state from garage door controller
        value_template: >-
          {% if is_state('binary_sensor.door_lock', 'off') %}
            closed
          {% elif is_state('binary_sensor.door_lock', 'on') %}
            open
          {% else %}
            unknown
          {% endif %}
        # Trigger the garage door (same action for open/close with Hörmann)
        open_cover:
          service: switch.turn_on
          target:
            entity_id: switch.garage_door
        close_cover:
          service: switch.turn_on
          target:
            entity_id: switch.garage_door
        # Optional: Stop not typically needed for garage doors
        stop_cover:
          service: switch.turn_on
          target:
            entity_id: switch.garage_door

# HomeKit Integration - Single Consolidated Bridge
homekit:
  - name: "House Main"
    port: 21064
    safe_mode: true
    filter:
      include_entities:
        # ========================================
        # ENVIRONMENTAL SENSORS (CO2 + Other)
        # ========================================
        
        # CO2 Sensors (alphabetical by room)
        - sensor.bedroom_co2_sensor_co2
        - sensor.bedroom_co2_sensor_temperature
        - sensor.bedroom_co2_sensor_humidity
        - sensor.living_room_co2_sensor_co2
        - sensor.living_room_co2_sensor_temperature
        - sensor.living_room_co2_sensor_humidity
        
        # Food Storage Sensor (kitchen)
        - sensor.food_storage_sensor_temperature
        - sensor.food_storage_sensor_humidity
        - sensor.food_storage_sensor_pressure
        - sensor.food_storage_sensor_battery
        
        # External Temperature Sensors (alphabetical by room)
        - sensor.bedroom_temperature_sensor_temperature
        - sensor.bedroom_temperature_sensor_humidity
        - sensor.bedroom_temperature_sensor_battery
        - sensor.entrance_temperature_sensor_temperature
        - sensor.entrance_temperature_sensor_humidity
        - sensor.entrance_temperature_sensor_battery
        - sensor.kids_room_temperature_sensor_temperature
        - sensor.kids_room_temperature_sensor_humidity
        - sensor.kids_room_temperature_sensor_battery
        - sensor.living_room_temperature_sensor_temperature
        - sensor.living_room_temperature_sensor_humidity
        - sensor.living_room_temperature_sensor_battery
        - sensor.workshop_temperature_sensor_temperature
        - sensor.workshop_temperature_sensor_humidity
        - sensor.workshop_temperature_sensor_battery
        
        # ========================================
        # CONTACT SENSORS (Windows/Doors)
        # ========================================
        
        # Window/Door Sensors (alphabetical by room)
        - binary_sensor.bedroom_window_sensor_contact
        - binary_sensor.kids_room_window_sensor_contact
        - binary_sensor.kitchen_window_sensor_contact
        - binary_sensor.living_room_door_sensor_contact
        - binary_sensor.workshop_window_sensor_contact
        
        # ========================================
        # LEAK SENSORS
        # ========================================
        
        # Leak Sensors (alphabetical by room)
        - binary_sensor.downstairs_bathroom_leak_sensor_water_leak
        - binary_sensor.kitchen_sink_leak_sensor_water_leak
        - binary_sensor.laundry_room_leak_sensor_water_leak
        - binary_sensor.upstairs_bathroom_leak_sensor_water_leak
        
        # ========================================
        # HEAT CONTROL (Climate Controls)
        # ========================================
        
        # Heat Valves (alphabetical by room)
        - climate.bedroom_radiator_heat_valve
        - climate.downstairs_bathroom_radiator_heat_valve
        - climate.entrance_radiator_heat_valve
        - climate.kids_room_radiator_heat_valve
        - climate.living_room_virtual_heating
        - climate.upstairs_bathroom_radiator_heat_valve
        - climate.workshop_radiator_heat_valve
        
        # ========================================
        # LIGHTING
        # ========================================
        
        # Lights (alphabetical by room)
        - light.bedroom_led_strip
        - light.kids_room_door_led_strip
        - light.living_room_light
        
        # ========================================
        # BOILER CONTROL
        # ========================================
        
        # Dual Relay Boiler Controller (L2+LOUT wired as single dry contact)
        # Only expose L2 to HomeKit - L2 relay controls the boiler
        - switch.laundry_room_boiler_controller_l2
        
        # ========================================
        # GARAGE DOOR
        # ========================================
        
        # Garage Door (control + position feedback)
        - cover.garage_door
        - binary_sensor.door_lock
    entity_config:
      # ========================================
      # ENVIRONMENTAL SENSORS
      # ========================================
      
      # CO2 Sensors
      sensor.bedroom_co2_sensor_co2:
        name: "Bedroom CO2"
        # CO2 threshold: HomeKit will warn when > 1500 ppm (default is 1000)
        co2_threshold: 1500
      sensor.bedroom_co2_sensor_temperature:
        name: "Bedroom Temperature (CO2)"
      sensor.bedroom_co2_sensor_humidity:
        name: "Bedroom Humidity (CO2)"
      sensor.living_room_co2_sensor_co2:
        name: "Living Room CO2"
        # CO2 threshold: HomeKit will warn when > 1500 ppm (default is 1000)
        co2_threshold: 1500
      sensor.living_room_co2_sensor_temperature:
        name: "Living Room Temperature (CO2)"
      sensor.living_room_co2_sensor_humidity:
        name: "Living Room Humidity (CO2)"
      
      # Food Storage Sensor
      sensor.food_storage_sensor_temperature:
        name: "Kitchen Food Storage Temperature"
      sensor.food_storage_sensor_humidity:
        name: "Kitchen Food Storage Humidity"
      sensor.food_storage_sensor_pressure:
        name: "Kitchen Food Storage Pressure"
      sensor.food_storage_sensor_battery:
        name: "Kitchen Sensor Battery"
      
      # External Temperature Sensors (alphabetical by room)
      sensor.bedroom_temperature_sensor_temperature:
        name: "Bedroom Temperature"
      sensor.entrance_temperature_sensor_temperature:
        name: "Entrance Temperature"
      sensor.kids_room_temperature_sensor_temperature:
        name: "Kids Room Temperature"
      sensor.living_room_temperature_sensor_temperature:
        name: "Living Room Temperature"
      sensor.workshop_temperature_sensor_temperature:
        name: "Workshop Temperature"
      
      # ========================================
      # CONTACT SENSORS
      # ========================================
      
      # Window/Door Sensors (alphabetical by room)
      binary_sensor.bedroom_window_sensor_contact:
        name: "Bedroom Window"
      binary_sensor.kids_room_window_sensor_contact:
        name: "Kids Room Window"
      binary_sensor.kitchen_window_sensor_contact:
        name: "Kitchen Window"
      binary_sensor.living_room_door_sensor_contact:
        name: "Living Room Door"
      binary_sensor.workshop_window_sensor_contact:
        name: "Workshop Window"
      
      # ========================================
      # LEAK SENSORS
      # ========================================
      
      # Leak Sensors (alphabetical by room)
      binary_sensor.downstairs_bathroom_leak_sensor_water_leak:
        name: "Downstairs Bathroom Leak"
      binary_sensor.kitchen_sink_leak_sensor_water_leak:
        name: "Kitchen Sink Leak"
      binary_sensor.laundry_room_leak_sensor_water_leak:
        name: "Laundry Room Leak"
      binary_sensor.upstairs_bathroom_leak_sensor_water_leak:
        name: "Upstairs Bathroom Leak"
      
      # ========================================
      # HEAT CONTROL
      # ========================================
      
      # Heat Valves (alphabetical by room)
      climate.bedroom_radiator_heat_valve:
        name: "Bedroom Heating"
      climate.downstairs_bathroom_radiator_heat_valve:
        name: "Downstairs Bathroom Heating"
      climate.entrance_radiator_heat_valve:
        name: "Entrance Heating"
      climate.kids_room_radiator_heat_valve:
        name: "Kids Room Heating"
      climate.living_room_virtual_heating:
        name: "Living Room Heating"
      climate.upstairs_bathroom_radiator_heat_valve:
        name: "Upstairs Bathroom Heating"
      climate.workshop_radiator_heat_valve:
        name: "Workshop Heating"
      
      # ========================================
      # LIGHTING
      # ========================================
      
      # Lights (alphabetical by room)
      light.bedroom_led_strip:
        name: "Bedroom LED Strip"
      light.kids_room_door_led_strip:
        name: "Kids Room Door LED Strip"
      light.living_room_light:
        name: "Living Room Light"
      
      # ========================================
      # BOILER CONTROL
      # ========================================
      
      # Dual Relay Boiler Controller (L2+LOUT wired as single dry contact)
      # Only L2 exposed to HomeKit - L2 relay controls the boiler
      switch.laundry_room_boiler_controller_l2:
        name: "Boiler Control"
      
      # ========================================
      # GARAGE DOOR
      # ========================================
      
      # Garage Door (control + position feedback)
      cover.garage_door:
        name: "Garage Door"
      binary_sensor.door_lock:
        name: "Garage Door Position"

# Shell commands for GitOps deployment
shell_command:
  deploy_zigbee2mqtt_config: >
    cp /config/zigbee2mqtt_configuration.yaml /config/zigbee2mqtt/configuration.yaml

# Recorder configuration for database optimization
recorder:
  db_url: "sqlite:////config/home-assistant_v2.db"
  purge_keep_days: 30
  include:
    domains:
      - sensor
      - light
      - switch
      - binary_sensor
      - automation
      - person
      - device_tracker
      - input_number
      - input_boolean
  exclude:
    entity_globs:
      - sensor.*_linkquality
      - sensor.*_voltage
      - sensor.*_update_state
      - sensor.home_assistant_*
      - sensor.*_cpu_percent
      - sensor.*_memory_percent

# Logger configuration
logger:
  default: info
  logs:
    homeassistant.components.mqtt: info
    homeassistant.components.automation: info