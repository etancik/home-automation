# House-specific scripts

# Shared CO2 LED Breathing Effect Script
co2_led_breathing_notification:
  alias: "CO2 LED Breathing Notification"
  description: "Breathe LED in specified color, then restore original state"
  fields:
    entity_id:
      description: "LED strip entity to control"
      required: true
    color:
      description: "RGB color for breathing [r, g, b]"
      required: true
    brightness:
      description: "Brightness level (0-255)"
      required: true
    cycles:
      description: "Number of breathing cycles"
      default: 1
  sequence:
    # Store current light state for restoration
    - service: scene.create
      data:
        scene_id: "co2_led_restore_{{ entity_id.split('.')[1] }}"
        snapshot_entities:
          - "{{ entity_id }}"
    
    # Breathing cycles with color restoration between each
    - repeat:
        count: "{{ cycles }}"
        sequence:
          # Start breathing in specified color
          - service: light.turn_on
            target:
              entity_id: "{{ entity_id }}"
            data:
              effect: "breathe"
              rgb_color: "{{ color }}"
              brightness: "{{ brightness }}"
              transition: 1
          # Wait for breathe cycle to complete (estimated)
          - delay: 2
          # Restore original color briefly between cycles (except last)
          - if:
              - condition: template
                value_template: "{{ repeat.index < cycles }}"
            then:
              - service: scene.turn_on
                data:
                  entity_id: "scene.co2_led_restore_{{ entity_id.split('.')[1] }}"
                  transition: 2
              - delay: 2
    
    # Final restoration to original state
    - service: scene.turn_on
      data:
        entity_id: "scene.co2_led_restore_{{ entity_id.split('.')[1] }}"
        transition: 5

# CO2 LED Notification Scripts
co2_led_red_pulse:
  alias: "CO2 Red Pulse Notification"
  description: "Gradually pulse LED red based on CO2 level intensity"
  fields:
    entity_id:
      description: "LED strip entity to control"
      example: "light.bedroom_led_strip"
    co2_level:
      description: "Current CO2 level in ppm"
      example: 1350
  sequence:
    # Calculate red intensity based on CO2 level (1200-2000+ ppm range)
    - variables:
        intensity: >
          {% set co2 = co2_level | int %}
          {% if co2 <= 1200 %}
            0.3
          {% elif co2 >= 2000 %}
            1.0
          {% else %}
            {{ 0.3 + (co2 - 1200) * 0.7 / 800 }}
          {% endif %}
        red_brightness: "{{ (255 * intensity) | int }}"
    
    # Use shared breathing effect
    - service: script.co2_led_breathing_notification
      data:
        entity_id: "{{ entity_id }}"
        color: [255, 0, 0]
        brightness: "{{ red_brightness }}"
        cycles: 1

co2_led_green_pulse:
  alias: "CO2 Green Pulse Notification"
  description: "Gentle green pulse for good air quality in winter"
  fields:
    entity_id:
      description: "LED strip entity to control"
      example: "light.bedroom_led_strip"
  sequence:
    # Use shared breathing effect with soft green
    - service: script.co2_led_breathing_notification
      data:
        entity_id: "{{ entity_id }}"
        color: [0, 255, 100]  # Soft green with slight yellow tint
        brightness: 100
        cycles: 1

co2_led_restore_normal:
  alias: "Restore Normal LED State"
  description: "Restore LED to previous state before CO2 notification"
  fields:
    entity_id:
      description: "LED strip entity to restore"
      example: "light.bedroom_led_strip"
  sequence:
    # Restore the saved scene
    - service: scene.turn_on
      data:
        entity_id: "scene.co2_led_restore_{{ entity_id.split('.')[1] }}"
        transition: 5
    
    # Clean up the temporary scene after restoration
    - delay: 3
    - service: scene.delete
      data:
        entity_id: "scene.co2_led_restore_{{ entity_id.split('.')[1] }}"
      continue_on_error: true