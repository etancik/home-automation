# ================================================================================================
# Energy Monitoring Package for go-e Charger & Controller
# ================================================================================================
# 
# The Energy dashboard uses TWO types of sensors:
# 
# 1. POWER SENSORS (W/kW with state_class: measurement)
#    - Shows REAL-TIME energy flow diagram
#    - Continuously updated instantaneous readings
#    - Required attributes: device_class: power, state_class: measurement
#    - Power sensors are OPTIONAL but enhance the dashboard with live flow visualization
# 
# 2. ENERGY SENSORS (Wh/kWh with state_class: total or total_increasing)
#    - Tracks CUMULATIVE consumption over time (hourly, daily, monthly, yearly)
#    - Required attributes: device_class: energy, state_class: total_increasing (or total)
#    - These are REQUIRED for Energy dashboard statistics
# 
# Important distinction from HA docs:
# - "Energy is the distance driven" (cumulative kWh)
# - "Power is the speed you are going" (instantaneous W)
# - Energy dashboard does Riemann sum integration if you only have power sensors
# 
# ================================================================================================

# ------------------------------------------------------------------------------------------------
# Available Sensors from MQTT Auto-Discovery
# ------------------------------------------------------------------------------------------------
# 
# POWER SENSORS (for real-time flow diagram - state_class: measurement):
# - sensor.go_echarger_600187_power_total (0.0 W) - Current charging power
# - sensor.go_econtroller_917809_home_power (206.51 W) - Current home consumption
# - sensor.go_econtroller_917809_grid_power (W) - Current grid power
# - sensor.go_econtroller_917809_car_power (W) - Current car power
# 
# ENERGY SENSORS (for cumulative tracking - state_class: total/total_increasing):
# - sensor.go_echarger_600187_total_energy_charged (73.59 kWh) ✅ state_class: total_increasing
# - sensor.go_econtroller_917809_grid_energy_in (1007.12 kWh) ⚠️  state_class: total (acceptable but not ideal)
# - sensor.go_econtroller_917809_home_energy_in (1007.12 kWh) ⚠️  state_class: total (acceptable but not ideal)
# 
# Per HA docs: Both "total" and "total_increasing" are accepted by Energy dashboard
# - "total" = can increase or decrease (e.g., battery, bidirectional meter)
# - "total_increasing" = only increases (e.g., utility meter, EV charging)
# 
# Best practice: Use "total_increasing" when values never decrease to avoid statistics issues
# 
# ------------------------------------------------------------------------------------------------

# Template sensors to fix state_class for Energy dashboard compatibility
# (Energy dashboard requires state_class: total_increasing, but go-eController provides "total")
template:
  - sensor:
      # Grid Energy Consumption (fixed state_class)
      - name: "Grid Energy Consumed"
        unique_id: grid_energy_consumed
        state: "{{ states('sensor.go_econtroller_917809_grid_energy_in') }}"
        unit_of_measurement: "Wh"
        device_class: energy
        state_class: total_increasing
        availability: "{{ states('sensor.go_econtroller_917809_grid_energy_in') not in ['unknown', 'unavailable'] }}"
        attributes:
          friendly_name: "Grid Energy Consumed"
          source: "go-eController Grid Energy In (state_class fixed)"
          
      # Home Energy Consumption (fixed state_class)
      - name: "Home Energy Consumed"
        unique_id: home_energy_consumed
        state: "{{ states('sensor.go_econtroller_917809_home_energy_in') }}"
        unit_of_measurement: "Wh"
        device_class: energy
        state_class: total_increasing
        availability: "{{ states('sensor.go_econtroller_917809_home_energy_in') not in ['unknown', 'unavailable'] }}"
        attributes:
          friendly_name: "Home Energy Consumed"
          source: "go-eController Home Energy In (state_class fixed)"

# ================================================================================================
# Energy Dashboard Configuration Guide (Based on HA Official Docs)
# ================================================================================================
# 
# Go to: Settings → Dashboards → Energy
# 
# SETUP PRIORITY (recommended order):
# 
# 1. GRID CONSUMPTION (Foundation - shows total energy imported from grid):
#    - Click "Add Consumption" under "Electricity grid"
#    - Energy sensor: sensor.grid_energy_consumed (1007 kWh cumulative)
#    - Power sensor (optional): sensor.go_econtroller_917809_grid_power (live flow)
#    - Energy sensor is REQUIRED, power sensor is optional but adds real-time visualization
# 
# 2. INDIVIDUAL DEVICES - EV CHARGER (Track high-consumption devices separately):
#    - Under "Individual devices", click "Add device"
#    - Energy sensor: sensor.go_echarger_600187_total_energy_charged (73.59 kWh)
#    - Power sensor (auto-detected): sensor.go_echarger_600187_power_total (0.0 W)
#    - This prevents EV charging from being lost in "home consumption" totals
#    - Recommended per HA docs for any device >1kW
# 
# 3. FUTURE ADDITIONS (when available):
#    - Solar panels: Track production (reduces grid consumption shown)
#    - Battery: Track charge/discharge cycles (use state_class: total not total_increasing)
#    - Gas: Track heating fuel usage separately
#    - Individual smart plugs: Monitor specific appliances (dishwasher, dryer, etc.)
# 
# BEST PRACTICES FROM HA COMMUNITY:
# - Add grid consumption FIRST before any individual devices
# - Use "Individual devices" for anything using >1kW regularly (EV, heat pump, AC)
# - Don't over-complicate - start simple and add devices as needed
# - Check Developer Tools → Statistics regularly for sensor issues
# - Energy dashboard needs 2 hours of data before showing statistics
# 
# COMMON PITFALLS TO AVOID:
# - Don't use power (W) sensors where energy (kWh) is required
# - Don't mix units (all sensors must use consistent Wh or kWh)
# - Ensure recorder is tracking all energy sensors (check configuration.yaml)
# - If sensor doesn't appear in dropdown, check state_class and device_class attributes
# 
# ================================================================================================
